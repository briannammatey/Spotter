<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Spotter</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        .profile-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .profile-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 30px;
            align-items: start;
        }

        .profile-picture {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin: 0 0 5px 0;
        }

        .profile-email {
            color: #718096;
            font-size: 16px;
            margin: 0 0 15px 0;
        }

        .profile-bio {
            color: #4a5568;
            font-size: 16px;
            line-height: 1.6;
            margin: 15px 0;
        }

        .profile-meta {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .profile-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #4a5568;
            font-size: 14px;
        }

        .edit-profile-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
        }

        .edit-profile-btn:hover {
            background: #5568d3;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin: 5px 0;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin: 30px 0 15px 0;
        }

        .activities-list {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .activity-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .activity-info {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: #2d3748;
            margin: 0 0 5px 0;
        }

        .activity-date {
            color: #718096;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #718096;
            background: none;
            border: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #2d3748;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .btn-save {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .btn-save:hover {
            background: #5568d3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success-message {
            background: #c6f6d5;
            color: #2f855a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
<header class="site-header">
    <div id="background">
        <nav id="navbar">
            <div class="brand">
                <img id="bu_pic" src="/img/bu_dog.png">
                <p id="title">üêæSPOTTER üêæ</p>
            </div>
            <ul>
                <li><a href="homepage.html">Homepage</a></li>
                <li><a href="index.html">Challenge</a></li>
                <li><a href="workoutsection.html">Workout</a></li>
                <li><a href="recipe.html">Recipes</a></li>
                <li><a href="addFriends.html">AddFriends</a></li>
                <li><a href="profile.html">Profile</a></li>
                <li><a href="#" onclick="logout(); return false;">üö™ Logout</a></li>
            </ul>
        </nav>
    </div>
</header>

<div class="webbody">
    <div class="profile-container">
        <div id="loadingState" class="loading">
            <p>Loading profile...</p>
        </div>

        <div id="errorState" class="error-message" style="display: none;"></div>

        <div id="profileContent" style="display: none;">
            <!-- Profile Header -->
            <div class="profile-header">
                <div class="profile-picture" id="profilePicture">
                    üë§
                </div>
                <div class="profile-info">
                    <h1 class="profile-name" id="profileName">Loading...</h1>
                    <p class="profile-email" id="profileEmail"></p>
                    <p class="profile-bio" id="profileBio">No bio yet</p>
                    <div class="profile-meta">
                        <div class="profile-meta-item">
                            <span>üéØ</span>
                            <span id="fitnessGoal">No goal set</span>
                        </div>
                        <div class="profile-meta-item">
                            <span>üí™</span>
                            <span id="favoriteWorkout">No favorite workout</span>
                        </div>
                        <div class="profile-meta-item">
                            <span>üìÖ</span>
                            <span>Joined <span id="joinedDate"></span></span>
                        </div>
                    </div>
                    <button class="edit-profile-btn" id="editProfileBtn" onclick="openEditModal()">
                        ‚úèÔ∏è Edit Profile
                    </button>
                </div>
            </div>

            <!-- Friend Requests Section -->
            <div id="friendRequestsSection" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #856404;">üîî Friend Requests (<span id="requestCount">0</span>)</h3>
                <div id="friendRequestsList"></div>
            </div>

            <!-- Challenge Invitations Section -->
            <div id="challengeInvitationsSection" style="display: none; background: #e8f5e9; border: 2px solid #4caf50; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: #2e7d32;">üèÜ Challenge Invitations (<span id="challengeInviteCount">0</span>)</h3>
                <div id="challengeInvitationsList"></div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-value" id="statChallenges">0</div>
                    <div class="stat-label">Challenges Created</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí™</div>
                    <div class="stat-value" id="statWorkouts">0</div>
                    <div class="stat-label">Workouts Logged</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-value" id="statCalories">0</div>
                    <div class="stat-label">Calories Burned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="statFriends">0</div>
                    <div class="stat-label">Friends</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-value" id="statStreak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-value" id="statMinutes">0</div>
                    <div class="stat-label">Total Minutes</div>
                </div>
            </div>

            <!-- Recent Activities -->
            <h2 class="section-title">Recent Activities</h2>
            <div class="activities-list" id="activitiesList">
                <p style="text-align: center; color: #718096;">No recent activities</p>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Edit Profile</h2>
            <button class="close-modal" onclick="closeEditModal()">&times;</button>
        </div>
        
        <div id="modalMessage" style="display: none;"></div>

        <form id="editProfileForm">
            <div class="form-group">
                <label class="form-label" for="editUsername">Username</label>
                <input type="text" id="editUsername" class="form-input" placeholder="Your username">
            </div>

            <div class="form-group">
                <label class="form-label" for="editBio">Bio</label>
                <textarea id="editBio" class="form-textarea" placeholder="Tell us about yourself..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label" for="editFitnessGoal">Fitness Goal</label>
                <input type="text" id="editFitnessGoal" class="form-input" placeholder="e.g., Lose 10 lbs, Run a marathon">
            </div>

            <div class="form-group">
                <label class="form-label" for="editFavoriteWorkout">Favorite Workout</label>
                <input type="text" id="editFavoriteWorkout" class="form-input" placeholder="e.g., Running, Weightlifting">
            </div>

            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn-save">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Include auth utilities -->
<script src="auth-utils.js"></script>

<script>
// Check authentication on page load
requireAuth();

let currentProfile = null;

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

// Load profile data
async function loadProfile() {
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const profileContent = document.getElementById('profileContent');

    try {
        const response = await authFetch('/api/profile');
        const result = await response.json();

        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Failed to load profile');
        }

        currentProfile = result.profile;
        displayProfile(currentProfile);

        loadingState.style.display = 'none';
        profileContent.style.display = 'block';

    } catch (error) {
        console.error('Error loading profile:', error);
        loadingState.style.display = 'none';
        errorState.textContent = error.message;
        errorState.style.display = 'block';
    }
}

// Display profile data
function displayProfile(profile) {
    document.getElementById('profileName').textContent = profile.username;
    document.getElementById('profileEmail').textContent = profile.email;
    document.getElementById('profileBio').textContent = profile.bio || 'No bio yet';
    document.getElementById('fitnessGoal').textContent = profile.fitness_goal || 'No goal set';
    document.getElementById('favoriteWorkout').textContent = profile.favorite_workout || 'No favorite workout';
    document.getElementById('joinedDate').textContent = formatDate(profile.joined_date);

    // Display stats
    const stats = profile.stats;
    document.getElementById('statChallenges').textContent = stats.challenges_created;
    document.getElementById('statWorkouts').textContent = stats.workouts_logged;
    document.getElementById('statCalories').textContent = stats.total_calories_burned.toLocaleString();
    document.getElementById('statFriends').textContent = stats.friends_count;
    document.getElementById('statStreak').textContent = stats.current_streak;
    document.getElementById('statMinutes').textContent = stats.total_workout_minutes.toLocaleString();

    // Load recent activities
    loadRecentActivities();
    
    // Load friend requests
    loadFriendRequests();
    
    // Load challenge invitations
    loadChallengeInvitations();
}

// Load recent activities
async function loadRecentActivities() {
    try {
        const response = await authFetch('/api/profile/activities?limit=10');
        const result = await response.json();

        if (result.success && result.activities.length > 0) {
            const activitiesList = document.getElementById('activitiesList');
            activitiesList.innerHTML = result.activities.map(activity => {
                if (activity.type === 'challenge') {
                    return `
                        <div class="activity-item">
                            <span class="activity-icon">üèÜ</span>
                            <div class="activity-info">
                                <h4 class="activity-title">${activity.data.title}</h4>
                                <p class="activity-date">Created ${formatDate(activity.data.created_at)}</p>
                            </div>
                        </div>
                    `;
                } else if (activity.type === 'workout') {
                    return `
                        <div class="activity-item">
                            <span class="activity-icon">üí™</span>
                            <div class="activity-info">
                                <h4 class="activity-title">${activity.data.workout_name}</h4>
                                <p class="activity-date">${activity.data.duration} min ‚Ä¢ ${formatDate(activity.data.created_at)}</p>
                            </div>
                        </div>
                    `;
                }
                return '';
            }).join('');
        }
    } catch (error) {
        console.error('Error loading activities:', error);
    }
}

// Open edit modal
function openEditModal() {
    if (!currentProfile) return;

    document.getElementById('editUsername').value = currentProfile.username;
    document.getElementById('editBio').value = currentProfile.bio || '';
    document.getElementById('editFitnessGoal').value = currentProfile.fitness_goal || '';
    document.getElementById('editFavoriteWorkout').value = currentProfile.favorite_workout || '';

    document.getElementById('editModal').classList.add('active');
}

// Close edit modal
function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
    document.getElementById('modalMessage').style.display = 'none';
}

// Handle form submission
document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const modalMessage = document.getElementById('modalMessage');
    const submitBtn = e.target.querySelector('.btn-save');
    const originalText = submitBtn.textContent;

    submitBtn.textContent = 'Saving...';
    submitBtn.disabled = true;

    const profileData = {
        username: document.getElementById('editUsername').value.trim(),
        bio: document.getElementById('editBio').value.trim(),
        fitness_goal: document.getElementById('editFitnessGoal').value.trim(),
        favorite_workout: document.getElementById('editFavoriteWorkout').value.trim()
    };

    try {
        const response = await authFetch('/api/profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(profileData)
        });

        const result = await response.json();

        if (result.success) {
            modalMessage.className = 'success-message';
            modalMessage.textContent = 'Profile updated successfully!';
            modalMessage.style.display = 'block';

            // Reload profile
            setTimeout(() => {
                closeEditModal();
                loadProfile();
            }, 1000);
        } else {
            throw new Error(result.error || 'Failed to update profile');
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        modalMessage.className = 'error-message';
        modalMessage.textContent = error.message;
        modalMessage.style.display = 'block';
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

// Load friend requests
async function loadFriendRequests() {
    try {
        const response = await authFetch('/api/friend-requests');
        const result = await response.json();

        if (result.success && result.requests.length > 0) {
            const section = document.getElementById('friendRequestsSection');
            const requestsList = document.getElementById('friendRequestsList');
            const requestCount = document.getElementById('requestCount');
            
            requestCount.textContent = result.requests.length;
            section.style.display = 'block';
            
            requestsList.innerHTML = result.requests.map(req => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: white; border-radius: 10px; margin-bottom: 10px; border: 1px solid #ffc107;">
                    <div>
                        <strong style="font-size: 16px; color: #2d3748;">${req.from_username}</strong>
                        <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">${req.from_email}</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="handleFriendRequest('${req.from_email}', 'accept')" 
                                style="background: #51cf66; color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ‚úì Accept
                        </button>
                        <button onclick="handleFriendRequest('${req.from_email}', 'reject')" 
                                style="background: #ff6b6b; color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ‚úó Decline
                        </button>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading friend requests:', error);
    }
}

// Handle friend request (accept/reject)
async function handleFriendRequest(fromEmail, action) {
    try {
        const endpoint = action === 'accept' ? '/api/accept-friend-request' : '/api/reject-friend-request';
        const response = await authFetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ from_user_email: fromEmail })
        });

        const result = await response.json();

        if (result.success) {
            showMessage(`Friend request ${action}ed!`, 'success');
            // Reload friend requests and profile stats
            loadFriendRequests();
            loadProfile();
        } else {
            showMessage(result.error, 'error');
        }
    } catch (error) {
        console.error(`Error ${action}ing friend request:`, error);
        showMessage(`Failed to ${action} friend request`, 'error');
    }
}

// Show message helper
function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        ${type === 'success' ? 'background: #51cf66;' : 'background: #ff6b6b;'}
    `;
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// Load challenge invitations
async function loadChallengeInvitations() {
    try {
        const response = await authFetch('/api/challenge-invitations');
        const result = await response.json();

        if (result.success && result.invitations.length > 0) {
            const section = document.getElementById('challengeInvitationsSection');
            const invitationsList = document.getElementById('challengeInvitationsList');
            const inviteCount = document.getElementById('challengeInviteCount');
            
            inviteCount.textContent = result.invitations.length;
            section.style.display = 'block';
            
            invitationsList.innerHTML = result.invitations.map(inv => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: white; border-radius: 10px; margin-bottom: 10px; border: 1px solid #4caf50;">
                    <div>
                        <strong style="font-size: 18px; color: #2d3748;">üèÜ ${inv.challenge_title}</strong>
                        <p style="margin: 5px 0 0 0; color: #718096; font-size: 14px;">
                            Invited by <strong>${inv.inviter_username}</strong>
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="handleChallengeInvitation('${inv.challenge_id}', 'accept')" 
                                style="background: #51cf66; color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ‚úì Accept
                        </button>
                        <button onclick="handleChallengeInvitation('${inv.challenge_id}', 'decline')" 
                                style="background: #ff6b6b; color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ‚úó Decline
                        </button>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading challenge invitations:', error);
    }
}

// Handle challenge invitation (accept/decline)
async function handleChallengeInvitation(challengeId, action) {
    try {
        const endpoint = action === 'accept' ? '/api/accept-challenge-invitation' : '/api/decline-challenge-invitation';
        const response = await authFetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ challenge_id: challengeId })
        });

        const result = await response.json();

        if (result.success) {
            showMessage(`Challenge invitation ${action}ed!`, 'success');
            // Reload invitations and profile stats
            loadChallengeInvitations();
            loadProfile();
        } else {
            showMessage(result.error, 'error');
        }
    } catch (error) {
        console.error(`Error ${action}ing challenge invitation:`, error);
        showMessage(`Failed to ${action} challenge invitation`, 'error');
    }
}

// Load profile on page load
document.addEventListener('DOMContentLoaded', loadProfile);
</script>

</body>
</html>
