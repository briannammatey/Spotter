<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UserFeed</title>
    <link rel = "stylesheet" href = "style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>

<body>
<header class = "site-header">
    <div id = "background">
    
    <nav id = "navbar">
        <div class="brand">
        
        <img id ="bu_pic" src = "/img/bu_dog.png">
        <p id = "title">üêæSPOTTER üêæ</p>
        </div>
        <ul>
            <li><a href = "homepage.html">Homepage</a></li>
            <li><a href = "index.html">Challenge</a></li>
            <li><a href = "workoutsection.html">Workout</a></li>
            <li><a href = "recipe.html">Recipes</a></li>
            <li><a href="addFriends.html">AddFriends</a></li>
            <li><a href="profile.html">Profile</a></li>
            <li><a href="#" onclick="logout(); return false;">üö™ Logout</a></li>
        </ul>
    </nav>
    </div>
</header>

<div class ="webbody">
 <h2 id = "challenge">CREATE A NEW CHALLENGE</h2>
    <div class="box">
    <!-- Error/Success Messages -->
    <div id="messageContainer" style="display: none;"></div>
    
    <h4 class="questions">What Type of Challenge?</h4>
    <div class="button-toggle">
        <input type="radio" id="timeBased" name="challengeType" value="Time-Based">
        <label for="timeBased">Time-Based</label>

        <input type="radio" id="AchievementBased" name="challengeType" value="Achievement-Based">
        <label for="AchievementBased">Achievement-Based</label>
    </div>

    <h4 class="questions">Challenge Category</h4>
    <div class="button-toggle">
        <input type="radio" id="weightliftingCat" name="category" value="Weightlifting">
        <label for="weightliftingCat">Weightlifting</label>

        <input type="radio" id="cardioCat" name="category" value="Cardio">
        <label for="cardioCat">Cardio</label>

        <input type="radio" id="classesCat" name="category" value="Classes">
        <label for="classesCat">Classes</label>
    </div>

    <h4 class = "questions">Challenge Title</h4>
    <textarea id="challengeTitle" type="text" placeholder="Enter your Challenge Title here" class = "textBox"></textarea>

    <h4 class = "questions">Goal</h4>
    <textarea id="challengeGoal" type="text" placeholder="Enter your Goal here" class = "textBox"></textarea>
    
    <div id="AchievementFields" style="display: none;">
        <h4 class="questions">Target Value</h4>
        <input type="number" id="targetValueInput" placeholder="e.g., 100" min="0" step="0.1" class="textBox">

        <h4 class="questions">Metric</h4>
        <input type="text" id="metricInput" placeholder="e.g., miles, pounds, classes" class="textBox">
    </div>

    <h4 class = "questions">Start Date</h4>
    <label for="startDate"></label>
    <input type="date" id="startDate" class = "date-box">
    
    <h4 class = "questions">End Date</h4>
    <label for="endDate"></label>
    <input type="date" id="endDate" class = "date-box">

    <h4 class = "questions">Enter Challenge Description</h4>
    <textarea id="challengeDescription" class="big-box" placeholder="Describe your challenge..."></textarea>
     
    <h4 class="questions">Select privacy:</h4>
    <div class="button-toggle">
      <input type="radio" id="privateOption" name="privacy" value="private">
      <label for="privateOption">Private</label>

      <input type="radio" id="publicOption" name="privacy" value="public">
      <label for="publicOption">Public</label>
    </div>

    <div id="inviteSection">
    <h4 class="questions">Invite Friends:</h4>
    <div class="invite-friends-container">
      <input type="text" id="friendSearch" class="textBox" placeholder="Search for friends to invite...">
      <div class="invited-friends-list" id="invitedFriendsList">
        <!-- Selected friends will appear here -->
      </div>
    </div>
    </div>

    <br>

    <div class="button-toggle-2">
      <button type="button" id="startChallengeBtn" class="submit-challenge-btn">START CHALLENGE</button>
    </div>
    </div>
</div>

<!-- FIX 1: Move authentication check to TOP -->
<script>
// Check authentication FIRST
const token = localStorage.getItem("spotterToken");
if (!token) {
    window.location.href = "login.html";
}
</script>

<!-- FIX 2: Friend search and invite functionality -->
<script>
// Load actual friends from API
let actualFriends = [];
let invitedFriends = new Set();

// Load friends on page load
async function loadFriends() {
    const token = localStorage.getItem('spotterToken');
    if (!token) return;
    
    try {
        const response = await fetch('/api/friends', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const result = await response.json();
        
        if (result.success && result.friends) {
            actualFriends = result.friends.map(friend => ({
                email: friend.email,
                username: friend.username,
                displayName: `${friend.username} (${friend.email})`
            }));
        }
    } catch (error) {
        console.error('Error loading friends:', error);
    }
}

// Call loadFriends when page loads
document.addEventListener('DOMContentLoaded', loadFriends);

const friendSearchInput = document.getElementById('friendSearch');
const invitedFriendsList = document.getElementById('invitedFriendsList');

// Create dropdown for search suggestions
const dropdown = document.createElement('div');
dropdown.className = 'friend-dropdown';
dropdown.style.cssText = `
    display: none;
    position: absolute;
    background: white;
    border: 2px solid #ddb5b5;
    border-radius: 8px;
    max-height: 300px;
    overflow-y: auto;
    width: calc(100% - 4px);
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-top: 5px;
`;
friendSearchInput.parentElement.style.position = 'relative';
friendSearchInput.parentElement.appendChild(dropdown);

// Show or hide achievement fields based on challenge type
document.querySelectorAll('input[name="challengeType"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        const AchievementFields = document.getElementById('AchievementFields');
        if (e.target.value === 'Achievement-Based') {
            AchievementFields.style.display = 'block';
        } else {
            AchievementFields.style.display = 'none';
            document.getElementById('targetValueInput').value = '';
            document.getElementById('metricInput').value = '';
        }
    });
});

// Set minimum date to today
const today = new Date().toISOString().split('T')[0];
document.getElementById('startDate').min = today;
document.getElementById('endDate').min = today;

// Show dropdown on focus/click
friendSearchInput.addEventListener('focus', function() {
    showFriendsDropdown('');
});

// Add search functionality
friendSearchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    showFriendsDropdown(searchTerm);
});

// Function to show friends dropdown
function showFriendsDropdown(searchTerm) {
    if (actualFriends.length === 0) {
        dropdown.innerHTML = '<div class="friend-option" style="color: #999;">No friends yet. Add friends first!</div>';
        dropdown.style.display = 'block';
        return;
    }
    
    // Filter friends based on search term and already invited
    const matches = actualFriends.filter(friend => 
        !invitedFriends.has(friend.email) &&
        (searchTerm === '' || 
         friend.displayName.toLowerCase().includes(searchTerm) ||
         friend.username.toLowerCase().includes(searchTerm) ||
         friend.email.toLowerCase().includes(searchTerm))
    );
    
    if (matches.length > 0) {
        dropdown.innerHTML = matches.map(friend => 
            `<div class="friend-option" data-email="${friend.email}" data-name="${friend.username}" 
                  style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;"
                  onmouseover="this.style.background='#fff5f5'"
                  onmouseout="this.style.background='white'">
                <strong style="color: #2d3748; font-size: 15px;">${friend.username}</strong><br>
                <small style="color: #718096;">${friend.email}</small>
            </div>`
        ).join('');
        dropdown.style.display = 'block';
    } else if (searchTerm) {
        dropdown.innerHTML = '<div class="friend-option" style="color: #999;">No matching friends found</div>';
        dropdown.style.display = 'block';
    } else {
        dropdown.style.display = 'none';
    }
}

// Handle friend selection from dropdown
dropdown.addEventListener('click', function(e) {
    const option = e.target.closest('.friend-option');
    if (option && option.hasAttribute('data-email')) {
        const friendEmail = option.getAttribute('data-email');
        const friendName = option.getAttribute('data-name');
        addFriend(friendEmail, friendName);
        friendSearchInput.value = '';
        dropdown.style.display = 'none';
    }
});

// Add friend to invited list
function addFriend(email, name) {
    if (invitedFriends.has(email)) return;
    
    invitedFriends.add(email);
    
    const friendTag = document.createElement('div');
    friendTag.className = 'friend-tag';
    friendTag.innerHTML = `
        <span>${name}</span>
        <span class="remove-friend" data-email="${email}">‚úï</span>
    `;
    
    invitedFriendsList.appendChild(friendTag);
}

// Remove friend from invited list
invitedFriendsList.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-friend')) {
        const friendEmail = e.target.getAttribute('data-email');
        invitedFriends.delete(friendEmail);
        e.target.parentElement.remove();
    }
});

// Hide dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!friendSearchInput.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
    }
});

// Toggle invite section based on privacy
const inviteSection = document.getElementById('inviteSection');
const privacyRadios = document.getElementsByName('privacy');

function toggleInviteSection() {
    const privateSelected = document.getElementById('privateOption').checked;
    if (privateSelected) {
        inviteSection.style.display = 'none';
    } else {
        inviteSection.style.display = 'block';
    }
}

privacyRadios.forEach(radio => {
    radio.addEventListener('change', toggleInviteSection);
});

// Default to showing if nothing selected
toggleInviteSection();

// Show message function
function showMessage(message, type) {
    const messageContainer = document.getElementById('messageContainer');
    messageContainer.innerHTML = message;
    messageContainer.className = type === 'success' ? 'success-message' : 'error-message';
    messageContainer.style.display = 'block';
    
    // Auto-hide after 5 seconds for errors
    if (type === 'error') {
        setTimeout(() => {
            messageContainer.style.display = 'none';
        }, 5000);
    }
}
</script>

<!-- FIX 3: Challenge submission with authentication -->
<script>
// Form submission handler
document.getElementById('startChallengeBtn').addEventListener('click', async function() {
    // Get form values
    const challengeType = document.querySelector('input[name="challengeType"]:checked')?.value;
    const category = document.querySelector('input[name="category"]:checked')?.value;
    const title = document.getElementById('challengeTitle').value.trim();
    const goal = document.getElementById('challengeGoal').value.trim();
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const description = document.getElementById('challengeDescription').value.trim();
    const privacy = document.querySelector('input[name="privacy"]:checked')?.value;
    
    // Client-side validation
    const errors = [];
    
    if (!challengeType) errors.push("Please select a challenge type");
    if (!category) errors.push("Please select a category");
    if (!title) errors.push("Challenge title is required");
    if (!goal) errors.push("Goal is required");
    if (!startDate) errors.push("Start date is required");
    if (!endDate) errors.push("End date is required");
    if (!description) errors.push("Challenge description is required");
    if (!privacy) errors.push("Privacy setting is required");
    
    if (startDate && endDate && new Date(endDate) <= new Date(startDate)) {
        errors.push("End date must be after start date");
    }
    
    // Achievement-based specific validation
    let targetValue, metric;
    if (challengeType === 'Achievement-Based') {
        targetValue = document.getElementById('targetValueInput').value;
        metric = document.getElementById('metricInput').value.trim();
        
        if (!targetValue || parseFloat(targetValue) <= 0) {
            errors.push("Please enter a valid target value greater than 0");
        }
        if (!metric) {
            errors.push("Please enter a metric (e.g., miles, pounds, classes)");
        }
    }

    if (errors.length > 0) {
        showMessage(errors.join('<br>'), 'error');
        return;
    }
    
    // Prepare data
    const challengeData = {
        challenge_type: challengeType,
        category: category,
        title,
        goal,
        start_date: startDate,
        end_date: endDate,
        description,
        privacy,
        invited_friends: Array.from(invitedFriends)
    };
    
    // Add achievement-based specific fields
    if (challengeType === 'Achievement-Based') {
        challengeData.target_value = parseFloat(targetValue);
        challengeData.metric = metric;
    }

    // Disable button while submitting
    const btn = document.getElementById('startChallengeBtn');
    const originalText = btn.textContent;
    btn.textContent = 'CREATING...';
    btn.disabled = true;
    
    try {
        // Get auth token
        const token = localStorage.getItem("spotterToken");
        
        // Send to backend
        const response = await fetch('/api/create_challenge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(challengeData)
        });
        
        // FIX: Better error handling
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            if (response.status === 401) {
                // Token expired
                localStorage.removeItem("spotterToken");
                window.location.href = "login.html";
                return;
            }
            throw new Error(errorData.error || `Server returned ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('Challenge created successfully! Redirecting...', 'success');
            // Redirect to homepage after 1.5 seconds
            setTimeout(() => {
                window.location.href = 'homepage.html';
            }, 1500);
        } else {
            showMessage(result.errors.join('<br>'), 'error');
            btn.textContent = originalText;
            btn.disabled = false;
        }
    } catch (error) {
        console.error('Challenge creation error:', error);
        showMessage(error.message || 'Error connecting to server. Please make sure the backend is running.', 'error');
        btn.textContent = originalText;
        btn.disabled = false;
    }
});
</script>

</body>
</html>