<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage - Spotter</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
</head>

<body>
<header class="site-header">
    <div id="background">
        <nav id="navbar">
            <div class="brand">
                <img id="bu_pic" src="/img/bu_dog.png">
                <p id="title">üêæSPOTTER üêæ</p>
            </div>
            <ul>
                <li><a href="homepage.html">Homepage</a></li>
                <li><a href="index.html">Challenge</a></li>
                <li><a href="workoutsection.html">Workout</a></li>
                <li><a href="recipe.html">Recipes</a></li>
                <li><a href="addFriends.html">AddFriends</a></li>
                <li><a href="profile.html">Profile</a></li>
                <li><a href="#" onclick="logout(); return false;">üö™ Logout</a></li>
            </ul>
        </nav>
    </div>
</header>

<div class="webbody">
    <h2 id="challenge">ACTIVITY FEED</h2>
    
    <div class="feed-container" id="feedContainer">
        <!-- Activity Feed Items will be loaded dynamically -->
        <div class="loading-message" id="loadingMessage">
            <p>Loading activities...</p>
        </div>
        
        <!-- Empty State Message (shown when there are no activities) -->
        <div class="feed-empty" id="emptyState" style="display: none;">
            <div class="empty-icon">üì≠</div>
            <h3>No Activities Yet</h3>
            <p>Start your fitness journey by logging a workout or creating a challenge!</p>
            <div class="empty-actions">
                <a href="logWorkout.html" class="empty-btn">Log Workout</a>
                <a href="index.html" class="empty-btn">Create Challenge</a>
            </div>
        </div>
    </div>
</div>

<!-- Include auth utilities -->
<script src="auth-utils.js"></script>

<script>
// Check authentication on page load
requireAuth();

// Function to format date
function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

// Function to calculate time ago
function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
    return formatDate(dateString);
}

// Function to create a challenge feed item
function createChallengeFeedItem(challenge) {
    const postId = challenge.id;
    const postType = 'challenge';
    const liked = challenge.user_has_liked;
    const likeCount = challenge.like_count || 0;
    const commentCount = challenge.comment_count || 0;
    
    return `
        <div class="feed-item" data-post-id="${postId}" data-post-type="${postType}">
            <div class="feed-header">
                <div class="feed-user-info">
                    <div class="feed-avatar">üë§</div>
                    <div class="feed-user-details">
                        <h3 class="feed-username">${challenge.creator || 'User'}</h3>
                        <p class="feed-timestamp">${timeAgo(challenge.created_at)}</p>
                    </div>
                </div>
                <div class="feed-type-badge challenge-badge">üèÜ Challenge</div>
            </div>
            <div class="feed-content">
                <h4 class="feed-title">${challenge.title}</h4>
                <p class="feed-description">${challenge.description}</p>
                <div class="challenge-info">
                    <div class="challenge-detail">
                        <span class="challenge-label">Goal:</span>
                        <span class="challenge-value">${challenge.goal}</span>
                    </div>
                    <div class="challenge-detail">
                        <span class="challenge-label">Start:</span>
                        <span class="challenge-value">${formatDate(challenge.start_date)}</span>
                    </div>
                    <div class="challenge-detail">
                        <span class="challenge-label">End:</span>
                        <span class="challenge-value">${formatDate(challenge.end_date)}</span>
                    </div>
                    <div class="challenge-detail">
                        <span class="challenge-label">Participants:</span>
                        <span class="challenge-value">${challenge.participants || 1} joined</span>
                    </div>
                </div>
                ${challenge.invited_friends && challenge.invited_friends.length > 0 ? `
                    <div class="invited-friends-display">
                        <span class="friends-label">üë• Invited:</span>
                        ${challenge.invited_friends.slice(0, 3).join(', ')}
                        ${challenge.invited_friends.length > 3 ? ` +${challenge.invited_friends.length - 3} more` : ''}
                    </div>
                ` : ''}
            </div>
            <div class="feed-actions">
                <button class="feed-btn like-btn ${liked ? 'liked' : ''}" onclick="toggleLike('${postId}', '${postType}', this)">
                    ${liked ? '‚ù§Ô∏è' : 'ü§ç'} <span class="like-count">${likeCount}</span>
                </button>
                <button class="feed-btn comment-btn" onclick="toggleComments('${postId}', '${postType}')">
                    üí¨ <span class="comment-count">${commentCount}</span>
                </button>
            </div>
            <div class="comments-section" id="comments-${postId}" style="display: none;">
                <div class="comment-input-container">
                    <input type="text" placeholder="Write a comment..." class="comment-input" id="input-${postId}">
                    <button onclick="postComment('${postId}', '${postType}')" class="comment-submit-btn">Post</button>
                </div>
                <div class="comments-list" id="list-${postId}"></div>
            </div>
        </div>
    `;
}

// Function to create a workout feed item
function createWorkoutFeedItem(workout) {
    const postId = workout.id;
    const postType = 'workout';
    const liked = workout.user_has_liked;
    const likeCount = workout.like_count || 0;
    const commentCount = workout.comment_count || 0;
    
    // Map workout type to emoji
    const typeEmojis = {
        'cardio': 'üèÉ',
        'strength': 'üí™',
        'flexibility': 'üßò',
        'sports': '‚öΩ'
    };
    
    // Map intensity to display
    const intensityDisplay = {
        'low': 'Low',
        'medium': 'Medium',
        'high': 'High'
    };
    
    return `
        <div class="feed-item" data-post-id="${postId}" data-post-type="${postType}">
            <div class="feed-header">
                <div class="feed-user-info">
                    <div class="feed-avatar">üë§</div>
                    <div class="feed-user-details">
                        <h3 class="feed-username">${workout.creator || 'User'}</h3>
                        <p class="feed-timestamp">${timeAgo(workout.created_at)}</p>
                    </div>
                </div>
                <div class="feed-type-badge workout-badge">${typeEmojis[workout.workout_type] || 'üèãÔ∏è'} Workout</div>
            </div>
            <div class="feed-content">
                <h4 class="feed-title">${workout.workout_name}</h4>
                <p class="feed-description">${workout.notes}</p>
                <div class="feed-stats">
                    <span class="stat-item">üìÖ ${formatDate(workout.date)}</span>
                    <span class="stat-item">‚è±Ô∏è ${workout.duration} min</span>
                    ${workout.calories ? `<span class="stat-item">üî• ${workout.calories} cal</span>` : ''}
                    <span class="stat-item">üí™ ${intensityDisplay[workout.intensity] || workout.intensity}</span>
                    <span class="stat-item">${typeEmojis[workout.workout_type] || 'üèãÔ∏è'} ${workout.workout_type.charAt(0).toUpperCase() + workout.workout_type.slice(1)}</span>
                </div>
            </div>
            <div class="feed-actions">
                <button class="feed-btn like-btn ${liked ? 'liked' : ''}" onclick="toggleLike('${postId}', '${postType}', this)">
                    ${liked ? '‚ù§Ô∏è' : 'ü§ç'} <span class="like-count">${likeCount}</span>
                </button>
                <button class="feed-btn comment-btn" onclick="toggleComments('${postId}', '${postType}')">
                    üí¨ <span class="comment-count">${commentCount}</span>
                </button>
            </div>
            <div class="comments-section" id="comments-${postId}" style="display: none;">
                <div class="comment-input-container">
                    <input type="text" placeholder="Write a comment..." class="comment-input" id="input-${postId}">
                    <button onclick="postComment('${postId}', '${postType}')" class="comment-submit-btn">Post</button>
                </div>
                <div class="comments-list" id="list-${postId}"></div>
            </div>
        </div>
    `;
}

// Function to load activities
async function loadActivities() {
    const feedContainer = document.getElementById('feedContainer');
    const loadingMessage = document.getElementById('loadingMessage');
    const emptyState = document.getElementById('emptyState');
    
    try {
        const response = await authFetch('/api/activities');
        const result = await response.json();
        
        // Hide loading message
        loadingMessage.style.display = 'none';
        
        if (result.success && result.activities.length > 0) {
            // Hide empty state
            emptyState.style.display = 'none';
            
            // Display activities
            const feedHTML = result.activities.map(activity => {
                if (activity.type === 'challenge') {
                    return createChallengeFeedItem(activity);
                } else if (activity.type === 'workout') {
                    return createWorkoutFeedItem(activity);
                }
                // Add other activity types here (recipe, etc.)
                return '';
            }).join('');
            
            feedContainer.innerHTML = feedHTML;
        } else {
            // Show empty state
            emptyState.style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading activities:', error);
        loadingMessage.innerHTML = '<p style="color: #c92a2a;">Error loading activities. Please try again.</p>';
    }
}

// Toggle like on a post
async function toggleLike(postId, postType, button) {
    const likeCountSpan = button.querySelector('.like-count');
    const isLiked = button.classList.contains('liked');
    const endpoint = isLiked ? '/api/unlike' : '/api/like';
    
    try {
        const response = await authFetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ post_id: postId, post_type: postType })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update UI
            button.classList.toggle('liked');
            button.innerHTML = `${isLiked ? 'ü§ç' : '‚ù§Ô∏è'} <span class="like-count">${result.like_count}</span>`;
        }
    } catch (error) {
        console.error('Error toggling like:', error);
    }
}

// Toggle comments section
async function toggleComments(postId, postType) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    const commentsList = document.getElementById(`list-${postId}`);
    
    if (commentsSection.style.display === 'none') {
        commentsSection.style.display = 'block';
        // Load comments
        await loadComments(postId, postType, commentsList);
    } else {
        commentsSection.style.display = 'none';
    }
}

// Load comments for a post
async function loadComments(postId, postType, commentsList) {
    try {
        const response = await authFetch(`/api/comments/${postId}/${postType}`);
        const result = await response.json();
        
        if (result.success && result.comments.length > 0) {
            commentsList.innerHTML = result.comments.map(comment => `
                <div class="comment-item">
                    <strong>${comment.username}</strong>
                    <p>${comment.comment_text}</p>
                    <small>${timeAgo(comment.created_at)}</small>
                </div>
            `).join('');
        } else {
            commentsList.innerHTML = '<p style="text-align: center; color: #718096; padding: 10px;">No comments yet. Be the first!</p>';
        }
    } catch (error) {
        console.error('Error loading comments:', error);
    }
}

// Post a comment
async function postComment(postId, postType) {
    const input = document.getElementById(`input-${postId}`);
    const commentText = input.value.trim();
    
    if (!commentText) {
        return;
    }
    
    try {
        const response = await authFetch('/api/comment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                post_id: postId,
                post_type: postType,
                comment_text: commentText
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Clear input
            input.value = '';
            
            // Update comment count
            const feedItem = document.querySelector(`[data-post-id="${postId}"]`);
            const commentCountSpan = feedItem.querySelector('.comment-count');
            if (commentCountSpan) {
                commentCountSpan.textContent = result.comment_count;
            }
            
            // Reload comments
            const commentsList = document.getElementById(`list-${postId}`);
            await loadComments(postId, postType, commentsList);
        }
    } catch (error) {
        console.error('Error posting comment:', error);
    }
}

// Load activities when page loads
document.addEventListener('DOMContentLoaded', loadActivities);
</script>

<style>
.liked {
    background: #ffe8e8 !important;
}

.comments-section {
    padding: 15px;
    background: #f8f9fa;
    border-top: 1px solid #e2e8f0;
}

.comment-input-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.comment-input {
    flex: 1;
    padding: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-family: 'Poppins', sans-serif;
}

.comment-submit-btn {
    padding: 10px 20px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

.comment-submit-btn:hover {
    background: #5568d3;
}

.comment-item {
    background: white;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
}

.comment-item strong {
    color: #2d3748;
    font-size: 14px;
}

.comment-item p {
    margin: 5px 0;
    color: #4a5568;
}

.comment-item small {
    color: #718096;
    font-size: 12px;
}
</style>

</body>
</html>

