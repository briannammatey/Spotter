<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login - Spotter</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
</head>
<body>
<header class="site-header">
    <div id="background">
        <nav id="navbar">
            <div class="brand">
                <img id="bu_pic" src="/img/bu_dog.png">
                <p id="title">üêæSPOTTER üêæ</p>
            </div>
            <ul>
                <!-- After login, these links make sense -->
                <li><a href="homepage.html">Homepage</a></li>
                <li><a href="index.html">Challenge</a></li>
                <li><a href="logWorkout.html">Workout</a></li>
                <li><a href="recipe.html">Recipes</a></li>
                <li><a href="addFriends.html">AddFriends</a></li>
            </ul>
        </nav>
    </div>
</header>

<div class="webbody">
    <h2 id="challenge">üîë Login / Create Account</h2>
    <div class="box">
        <h4 class="questions">BU Email</h4>
        <input id="email" type="email" class="textBox" placeholder="you@bu.edu">

        <h4 class="questions">Password</h4>
        <input id="password" type="password" class="textBox" placeholder="Choose a password">

        <div id="confirmPasswordSection" style="display: none;">
            <h4 class="questions">Confirm Password</h4>
            <input id="confirmPassword" type="password" class="textBox" placeholder="Re-enter your password">
        </div>

        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="registerBtn" class="generate-btn">üìù Create Account</button>
            <button id="loginBtn" class="generate-btn">üîì Login</button>
        </div>

        <p id="authMessage" style="margin-top: 10px;"></p>
    </div>
</div>

<script>
const apiBase = "http://localhost:5001";

// If already "logged in", go straight to homepage
const existingToken = localStorage.getItem("spotterToken");
if (existingToken) {
    // You can change this to whatever main page you want
    window.location.href = "homepage.html";
}

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const confirmPasswordInput = document.getElementById("confirmPassword");
const confirmPasswordSection = document.getElementById("confirmPasswordSection");
const messageEl = document.getElementById("authMessage");
const registerBtn = document.getElementById("registerBtn");
const loginBtn = document.getElementById("loginBtn");

// Toggle active button state
function setActiveMode(mode) {
    if (mode === 'register') {
        confirmPasswordSection.style.display = 'block';
        registerBtn.style.opacity = '1';
        loginBtn.style.opacity = '0.7';
        passwordInput.placeholder = "Choose a password";
    } else {
        confirmPasswordSection.style.display = 'none';
        registerBtn.style.opacity = '0.7';
        loginBtn.style.opacity = '1';
        passwordInput.placeholder = "Enter your password";
        confirmPasswordInput.value = ''; // Clear confirm password
    }
    messageEl.textContent = ''; // Clear any messages
}

async function callAuth(endpoint) {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (!email || !password) {
        messageEl.textContent = "Please enter email and password.";
        messageEl.style.color = "red";
        return;
    }

    // Additional validation for registration
    if (endpoint === "register") {
        const confirmPassword = confirmPasswordInput.value.trim();
        
        if (!confirmPassword) {
            messageEl.textContent = "Please confirm your password.";
            messageEl.style.color = "red";
            return;
        }
        
        if (password !== confirmPassword) {
            messageEl.textContent = "Passwords do not match. Please try again.";
            messageEl.style.color = "red";
            return;
        }

        if (password.length < 6) {
            messageEl.textContent = "Password must be at least 6 characters long.";
            messageEl.style.color = "red";
            return;
        }
    }

    messageEl.textContent = "Processing...";
    messageEl.style.color = "black";

    try {
        const res = await fetch(`${apiBase}/api/${endpoint}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
        });

        const data = await res.json();
        console.log("Auth response:", data);

        if (!res.ok || !data.success) {
            messageEl.textContent = data.error || "Something went wrong.";
            messageEl.style.color = "red";
            return;
        }

        // Store simple "session"
        localStorage.setItem("spotterToken", data.token);
        localStorage.setItem("spotterEmail", data.email);

        messageEl.textContent = data.message + " Logged in as " + data.email;
        messageEl.style.color = "green";

        // Redirect to homepage after a moment
        setTimeout(() => {
            window.location.href = "homepage.html";
        }, 800);

    } catch (err) {
        console.error("Auth error:", err);
        messageEl.textContent = "Network error, please try again.";
        messageEl.style.color = "red";
    }
}

registerBtn.addEventListener("click", () => {
    setActiveMode('register');
    callAuth("register");
});

loginBtn.addEventListener("click", () => {
    setActiveMode('login');
    callAuth("login");
});
</script>

</body>
</html>
